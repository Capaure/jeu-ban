<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Partie — Jeu du Banni</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --bg:#0a0014; --violet:#9b4dff; --violet-strong:#d67bff; --panel:#1b0030;
      --border:#4a2a76; --tick:#3a2a5c; --text:#e0b3ff; --green:#13d67a; --gray:#2a2640; --red:#ff4d4d;
    }
    *{box-sizing:border-box}
    body { background:var(--bg); font-family:'Courier New', monospace; color:var(--text); margin:0; }
    h1 { color:var(--violet-strong); text-align:center; margin:18px 0 6px; text-shadow:0 0 15px var(--violet-strong); }
    #meta { text-align:center; opacity:.9; margin-bottom:8px; }

    .btn { padding:10px 18px; background:var(--violet); color:#fff; border:none; border-radius:10px; cursor:pointer; margin:4px; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .btn.danger { background:var(--red); }
    #backBtn { position:absolute; top:12px; right:12px; background:#ff4d6d; }

    #orderBlock { max-width:1200px; margin:8px auto 0; padding:0 10px; display:none; }
    #orderTitle { color:#bda9ff; opacity:.9; margin-bottom:6px; letter-spacing:.08em; }
    #boxesWrap { display:flex; flex-wrap:wrap; gap:8px; }
    .chip{ display:inline-flex; align-items:center; gap:8px; background:var(--gray); color:#e6dbff; border:1px solid #3b2d5e; border-radius:12px; padding:6px 10px; font-weight:700; }
    .chip .num{ background:#2a2448; border:1px solid #3f3266; padding:2px 8px; border-radius:999px; font-weight:800; }
    .chip .time{ opacity:.95; }
    .chip.active{ background:#3d1670; border-color:#b877ff; color:#fff; box-shadow:0 0 14px rgba(197,139,255,.45); }
    .chip.done{ background:#0f3b2b; border-color:#19b36b; color:#eafff3; }
    .chip.done .time{ color:#7CFC8A; }

    .videoBox { position:relative; width:min(95vw, 1200px); margin:10px auto; border:2px solid var(--violet-strong); border-radius:12px; overflow:hidden; }
    video { display:block; width:100%; height:auto; background:#000; }

    .timelineWrap { max-width:1200px; margin:8px auto; padding:0 8px; }
    .timeline { position:relative; height:92px; background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:visible; }
    .ticks { position:absolute; inset:0; pointer-events:none; }
    .tick { position:absolute; top:0; bottom:0; width:1px; background:var(--tick); }
    .tickLabel { position:absolute; bottom:6px; transform:translateX(-50%); font-size:12px; }
    .playhead { position:absolute; bottom:0; width:3px; height:100%; background:var(--violet-strong); box-shadow:0 0 14px var(--violet-strong); }
    .timeTag { position:absolute; top:-38px; background:#3a2a5c; color:#fff; padding:3px 8px; border-radius:8px; font-weight:bold; white-space:nowrap; display:none; }

    .barFooter { max-width:1200px; margin:6px auto 0; display:flex; justify-content:space-between; align-items:center; padding:0 10px; gap:8px; flex-wrap:wrap; }
    .rightBtns { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    #resultsGate { text-align:center; margin:14px 0; display:none; }
  </style>
</head>
<body>
  <button id="backBtn" class="btn">Accueil</button>
  <h1>Clip en cours</h1>
  <div id="meta"></div>

  <div id="orderBlock">
    <div id="orderTitle">ORDRE DE PASSAGE</div>
    <div id="boxesWrap"></div>
  </div>

  <div class="videoBox">
    <video id="videoPlayer" playsinline preload="metadata"></video>
  </div>

  <div class="timelineWrap">
    <div class="timeline" id="timeline">
      <div class="ticks" id="ticks"></div>
      <div class="playhead" id="playhead"></div>
      <div class="timeTag" id="timeTag">00:00.000</div>
    </div>
    <div class="barFooter">
      <span id="leftTime">00:00</span>
      <div class="rightBtns">
        <button id="previewBtn" class="btn" style="display:none;">Lancer le visionnage (2 restants)</button>
        <button id="startRoundBtn" class="btn" style="display:none;">Commencer la manche</button>
        <button id="actionBtn" class="btn" style="display:none;">Démarrer la vidéo</button>
        <button id="unlockAudioBtn" class="btn" style="display:none;">Activer le son (preview)</button>
        <span id="hint" style="font-size:12px;opacity:.8;"></span>
      </div>
      <span id="rightTime">00:00</span>
    </div>
  </div>

  <div id="resultsGate">
    <button id="seeResultsBtn" class="btn">VOIR LES RÉSULTATS</button>
  </div>

<script>
const socket = io({ transports:["websocket"] });
const q = new URLSearchParams(window.location.search);
let pseudo = q.get("pseudo") || "";
try { if (!pseudo) pseudo = localStorage.getItem("pseudo") || ""; } catch {}
try { if (pseudo) localStorage.setItem("pseudo", pseudo); } catch {}
if (!pseudo) pseudo = "Anonyme";
const code = (q.get("code")||"").toUpperCase();

// DOM
const video=document.getElementById("videoPlayer");
const previewBtn=document.getElementById("previewBtn");
const startRoundBtn=document.getElementById("startRoundBtn");
const actionBtn=document.getElementById("actionBtn");
const unlockAudioBtn=document.getElementById("unlockAudioBtn");
const timeline=document.getElementById("timeline");
const ticks=document.getElementById("ticks");
const playhead=document.getElementById("playhead");
const timeTag=document.getElementById("timeTag");
const orderBlock=document.getElementById("orderBlock");
const boxesWrap=document.getElementById("boxesWrap");
const hint=document.getElementById("hint");
const resultsGate=document.getElementById("resultsGate");
const seeResultsBtn=document.getElementById("seeResultsBtn");
const meta=document.getElementById("meta");
const leftTime=document.getElementById("leftTime");
const rightTime=document.getElementById("rightTime");

let isCreator=false, phase="idle";
let order=[], currentId=null, passedTimes={};
let clip="", streamer="", round=1, total=1;
let previewLeft=2, videoReady=false, audioUnlocked=false;

// utils
function fmtMMSS(t){const m=Math.floor(t/60),s=Math.floor(t%60).toString().padStart(2,"0");return `${m}:${s}`;}
function fmtFull(t){const m=Math.floor(t/60),s=Math.floor(t%60).toString().padStart(2,"0"),ms=Math.floor((t%1)*1000).toString().padStart(3,"0");return `${m}:${s}.${ms}`;}

function buildTicks(duration){
  ticks.innerHTML=""; if(!isFinite(duration)||duration<=0) return;
  const w = timeline.clientWidth; const step = duration<=20?1:2;
  for(let t=0;t<=duration+1e-6;t+=step){
    const x=(t/duration)*w;
    const tick=document.createElement("div"); tick.className="tick"; tick.style.left=x+"px";
    const lab=document.createElement("div"); lab.className="tickLabel"; lab.style.left=x+"px"; lab.textContent=fmtMMSS(t);
    ticks.appendChild(tick); ticks.appendChild(lab);
  }
}
function refreshTimeline(){
  const d = video.duration; if(!isFinite(d)||d<=0) return;
  buildTicks(d);
}
video.addEventListener("loadedmetadata", ()=>{ videoReady=true; refreshTimeline(); });
window.addEventListener("resize", refreshTimeline);

// chrono live (au millième)
(function raf(){
  const d = video.duration;
  if (isFinite(d) && d>0){
    const w = timeline.clientWidth;
    const x = Math.min(1, Math.max(0, video.currentTime/d)) * w;
    playhead.style.left = x + "px";
    timeTag.style.left  = x + "px";
    if (!video.paused && !video.ended) {
      timeTag.style.display="block";
      timeTag.textContent = fmtFull(video.currentTime);
    } else {
      timeTag.style.display="none";
    }
    leftTime.textContent = fmtMMSS(video.currentTime);
    rightTime.textContent= fmtMMSS(d);
  } else {
    timeTag.style.display="none";
  }
  requestAnimationFrame(raf);
})();
function ensureVideoReady(){
  if (videoReady) return Promise.resolve();
  return new Promise(res=> video.addEventListener("loadedmetadata", res, {once:true}));
}
function hidePreGameButtons(){ previewBtn.style.display="none"; startRoundBtn.style.display="none"; }

// Connexion
socket.emit("joinGame", { code, pseudo });
socket.emit("claimCreator", { code });
socket.emit("readyForRound", code);

socket.on("youAreCreator", ()=>{ 
  isCreator=true; 
  previewBtn.style.display="inline-block"; 
  startRoundBtn.style.display="inline-block"; 
});

// Nouveau round
socket.on("newRound",({clip:clipSrv,streamer:st,order:ord,round:r,roundsTotal:tot})=>{
  clip = clipSrv.startsWith("/")?clipSrv:`/${clipSrv}`;
  streamer = st || ""; round = r||1; total = tot||1;

  // charger la vidéo
  videoReady=false;
  video.src=clip; video.load();
  ensureVideoReady().catch(()=>{});

  // UI
  order = (ord||[]);
  passedTimes={}; currentId=null; renderBoxes();
  orderBlock.style.display = order.length? "block":"none";
  previewLeft = 2;
  meta.textContent = `Manche ${round}/${total} — ${streamer||""}`;
  hint.textContent = isCreator ? "Tu peux lancer 1 à 2 visionnages pour tout le monde, puis démarrer la manche." : "Visionnage global en attente du créateur.";
  previewBtn.textContent = `Lancer le visionnage (${previewLeft} restants)`;
  previewBtn.disabled = false;
  startRoundBtn.disabled = false; startRoundBtn.textContent="Commencer la manche";
  actionBtn.style.display="none";
  unlockAudioBtn.style.display = "inline-block"; // visible pour tout le monde
});

// Déverrouiller l'audio (preview)
unlockAudioBtn.onclick = async ()=>{
  try{
    await ensureVideoReady();
    video.muted=false; video.volume=1;
    video.currentTime=0;
    await video.play().catch(()=>{});
    video.pause();
    audioUnlocked = true;
    unlockAudioBtn.style.display = "none";
  }catch{}
};

// Visionnage global
previewBtn.onclick=async ()=>{
  if(!isCreator || previewLeft<=0) return;
  previewBtn.disabled=true; previewBtn.textContent="Visionnage en cours…";
  await ensureVideoReady().catch(()=>{});
  socket.emit("startPreview", code);
  setTimeout(()=>{ previewBtn.disabled=false; }, 200);
};
socket.on("previewStart", async ()=>{
  phase="preview";
  try{
    await ensureVideoReady();
    if (audioUnlocked) { video.muted=false; video.volume=1; }
    else { video.muted=true; video.volume=0; }
    video.currentTime=0;
    await video.play().catch(()=>{});
  }catch{}
  const onEnd = ()=> {
    phase="idle";
    video.removeEventListener("ended", onEnd);
    if(previewLeft>0){
      previewLeft--;
      if(isCreator){
        previewBtn.textContent = previewLeft>0 ? `Lancer le visionnage (${previewLeft} restants)` : "Visionnages épuisés";
        previewBtn.disabled = previewLeft===0;
      }
    }
  };
  video.addEventListener("ended", onEnd, {once:true});
});

// Démarrer la manche
startRoundBtn.onclick=()=>{
  if(!isCreator){ alert("Seul le créateur peut démarrer la manche."); return; }
  startRoundBtn.disabled=true; startRoundBtn.textContent="Démarrage…";
  socket.emit("startGame", code);
  hidePreGameButtons();
};

// Ordre + tours
socket.on("startTurn",({playerId,playerName})=>{
  currentId=playerId; renderBoxes();
  if(isCreator){ hidePreGameButtons(); }
  phase = "wait";
  hint.textContent = (socket.id===playerId) ? "Votre tour : 1 tentative." : `${playerName} joue…`;
  orderBlock.style.display="block";

  if(socket.id===playerId){
    let started=false, locked=false;
    actionBtn.style.display="inline-block"; actionBtn.disabled=false; actionBtn.textContent="Démarrer la vidéo"; actionBtn.classList.remove("danger");

    actionBtn.onclick=async ()=>{
      if(locked) return;
      if(!started){
        started=true; phase="attempt";
        try{
          await ensureVideoReady();
          video.currentTime=0; video.muted=false; video.volume=1;
          await video.play().catch(()=>{});
          actionBtn.textContent="Stopper la vidéo";
          actionBtn.classList.add("danger");
        }catch{}
      }else{
        video.pause(); phase="wait";
        const t=video.currentTime||0;
        locked=true; actionBtn.disabled=true;
        socket.emit("stopAt",{code,time:t,duration:video.duration});
        hint.textContent = "Fin de la tentative.";
      }
    };
  }else{
    actionBtn.style.display="none";
  }
});

socket.on("playerStopped",({playerId,time})=>{ passedTimes[playerId]=Number(time)||0; renderBoxes(); });

// Résultats & navigation
socket.on("roundSummary", () => {
  resultsGate.style.display = isCreator ? "block" : "none";
  if (!isCreator) hint.textContent = "En attente du créateur…";
});
seeResultsBtn.onclick = () => { if (isCreator) socket.emit("openResults", code); };
socket.on("goToResults", () => {
  window.location.href = `/results.html?code=${encodeURIComponent(code)}&pseudo=${encodeURIComponent(pseudo)}`;
});
socket.on("goToGame", () => { socket.emit("readyForRound", code); });
socket.on("gameOver", () => {
  window.location.href = `/podium.html?code=${encodeURIComponent(code)}&pseudo=${encodeURIComponent(pseudo)}`;
});

// back
document.getElementById("backBtn").onclick = () => window.location.href = "/index.html";

// rendu ordre
function renderBoxes(){
  boxesWrap.innerHTML="";
  order.sort((a,b)=>a.order-b.order).forEach(p=>{
    const chip=document.createElement("div"); chip.className="chip";
    if(p.id===currentId) chip.classList.add("active");
    if(passedTimes[p.id]!=null) chip.classList.add("done");
    const num=document.createElement("span"); num.className="num"; num.textContent=`${p.order}.`;
    const name=document.createElement("span"); name.textContent=p.name;
    const time=document.createElement("span"); time.className="time";
    if(passedTimes[p.id]!=null) time.textContent=` (${fmtFull(passedTimes[p.id])})`;
    chip.appendChild(num); chip.appendChild(name); chip.appendChild(time);
    boxesWrap.appendChild(chip);
  });
}

// erreurs
socket.on("errorMsg", m => alert(m));
video.addEventListener("error", () => {
  const src = video.currentSrc || video.src;
  alert("Impossible de charger la vidéo : " + src +
        "\nVérifie que le fichier existe bien dans /public (ex: /clipsite/clip1.mp4).");
});
</script>
</body>
</html>
